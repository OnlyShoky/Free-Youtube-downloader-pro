<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouTube Downloader Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --bg-tertiary: #2d2d2d;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --accent: #3a6df0;
            --accent-hover: #2855d6;
            --success: #4caf50;
            --warning: #ff9800;
            --error: #f44336;
            --border: #404040;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .container {
            width: 100%;
            max-width: 850px;
            background: var(--bg-secondary);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 10px 30px var(--shadow);
            border: 1px solid var(--border);
        }

        .header {
            background: var(--bg-tertiary);
            padding: 28px 32px;
            text-align: center;
            border-bottom: 1px solid var(--border);
        }

        .header h1 {
            font-size: 28px;
            font-weight: 600;
            margin-bottom: 8px;
            letter-spacing: 0.5px;
        }

        .header p {
            color: var(--text-secondary);
            font-size: 16px;
            font-weight: 400;
        }

        .content {
            padding: 32px;
        }

        .config-section {
            background: var(--bg-tertiary);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
        }

        .config-section h3 {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 16px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
        }

        .config-section h3::before {
            content: "锔";
            margin-right: 10px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-primary);
            font-size: 15px;
        }

        .navegador-select, .url-input {
            width: 100%;
            padding: 14px 16px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: 8px;
            font-size: 15px;
            color: var(--text-primary);
            transition: all 0.3s ease;
            outline: none;
        }

        .navegador-select:focus, .url-input:focus {
            border-color: var(--accent);
            box-shadow: 0 0 0 2px rgba(58, 109, 240, 0.2);
        }

        .info-text {
            background: rgba(58, 109, 240, 0.1);
            padding: 14px;
            border-radius: 8px;
            margin-top: 16px;
            font-size: 14px;
            color: var(--text-secondary);
            border-left: 3px solid var(--accent);
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            outline: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(58, 109, 240, 0.25);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
        }

        .spinner {
            border: 3px solid rgba(58, 109, 240, 0.2);
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        .error {
            background: rgba(244, 67, 54, 0.1);
            color: var(--error);
            padding: 16px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 3px solid var(--error);
            display: none;
            font-size: 14px;
        }

        .error.visible {
            display: block;
        }

        .video-info {
            background: var(--bg-tertiary);
            padding: 24px;
            border-radius: 8px;
            margin-bottom: 24px;
            border: 1px solid var(--border);
            display: none;
        }

        .video-info.visible {
            display: block;
            animation: fadeIn 0.4s ease;
        }

        .video-info h3 {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 20px;
            color: var(--text-primary);
            display: flex;
            align-items: center;
        }

        .video-info h3::before {
            content: "";
            margin-right: 10px;
        }

        .video-thumbnail {
            width: 100%;
            max-width: 320px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid var(--border);
        }

        .video-info p {
            margin-bottom: 12px;
            font-size: 15px;
        }

        .video-info p strong {
            color: var(--text-primary);
            font-weight: 500;
        }

        .video-info h4 {
            font-size: 16px;
            font-weight: 500;
            margin: 24px 0 16px;
            color: var(--text-primary);
        }

        .format-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }

        .format-card {
            background: var(--bg-primary);
            padding: 20px;
            border-radius: 8px;
            border: 1px solid var(--border);
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .format-card:hover {
            transform: translateY(-2px);
            border-color: var(--accent);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .format-card.selected {
            border-color: var(--accent);
            background: rgba(58, 109, 240, 0.1);
        }

        .format-card h4 {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .format-card p {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .download-status {
            background: var(--bg-tertiary);
            padding: 24px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--border);
            display: none;
        }

        .download-status.visible {
            display: block;
            animation: fadeIn 0.4s ease;
        }

        .download-status h3 {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 20px;
            color: var(--text-primary);
        }

        .progress-bar {
            width: 100%;
            height: 12px;
            background: var(--bg-primary);
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress {
            height: 100%;
            background: var(--accent);
            width: 0%;
            transition: width 0.4s ease;
            border-radius: 10px;
        }

        .download-link {
            display: inline-flex;
            align-items: center;
            padding: 14px 28px;
            background: var(--success);
            color: white;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 500;
            margin-top: 16px;
            transition: all 0.3s ease;
        }

        .download-link:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.25);
            background: #43a047;
        }

        .warning {
            background: rgba(255, 152, 0, 0.1);
            border-left: 3px solid var(--warning);
            padding: 14px;
            margin: 16px 0;
            border-radius: 6px;
            font-size: 14px;
            color: var(--warning);
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @media (max-width: 768px) {
            .container {
                border-radius: 10px;
            }
            
            .header {
                padding: 24px 20px;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            .content {
                padding: 24px 20px;
            }
            
            .format-options {
                grid-template-columns: 1fr;
            }
            
            .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>YouTube Downloader Pro</h1>
            <p>Descarga videos y audio de YouTube en alta calidad</p>
        </div>

        <div class="content">
            <div class="config-section">
                <h3>Configuraci贸n</h3>
                <div class="input-group">
                    <label for="navegadorSelect">Navegador para cookies:</label>
                    <select id="navegadorSelect" class="navegador-select">
                        <option value="">Cargando navegadores...</option>
                    </select>
                </div>
                <div id="navegadorInfo" class="info-text" style="display: none;">
                    <p>Las cookies ayudan a evitar bloqueos de YouTube. Selecciona el navegador donde tengas sesi贸n iniciada.</p>
                </div>
            </div>

            <div class="input-group">
                <label for="videoUrl">URL del video de YouTube:</label>
                <input type="url" id="videoUrl" class="url-input" placeholder="https://www.youtube.com/watch?v=..." required>
            </div>

            <button id="btnInfo" class="btn btn-primary">Obtener Informaci贸n del Video</button>

            <div id="loading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Analizando video...</p>
            </div>

            <div id="error" class="error"></div>

            <div id="videoInfo" class="video-info">
                <h3>Informaci贸n del Video</h3>
                <img id="videoThumbnail" class="video-thumbnail" src="" alt="Miniatura">
                <p><strong>T铆tulo:</strong> <span id="videoTitle"></span></p>
                <p><strong>Autor:</strong> <span id="videoAuthor"></span></p>
                <p><strong>Duraci贸n:</strong> <span id="videoDuration"></span></p>
                <p><strong>Vistas:</strong> <span id="videoViews"></span></p>

                <h4>Selecciona el formato de descarga:</h4>
                <div class="format-options" id="formatOptions">
                    <!-- Los formatos se insertar谩n aqu铆 din谩micamente -->
                </div>

                <button id="btnDownload" class="btn btn-primary" disabled>Iniciar Descarga</button>
            </div>

            <div id="downloadStatus" class="download-status">
                <h3>Progreso de Descarga</h3>
                <div class="progress-bar">
                    <div class="progress" id="downloadProgress"></div>
                </div>
                <p id="statusText">Preparando descarga...</p>
                <a id="downloadLink" class="download-link" style="display: none;">Descargar Archivo</a>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const videoUrl = document.getElementById('videoUrl');
            const btnInfo = document.getElementById('btnInfo');
            const btnDownload = document.getElementById('btnDownload');
            const videoInfo = document.getElementById('videoInfo');
            const downloadStatus = document.getElementById('downloadStatus');
            const loading = document.getElementById('loading');
            const errorDiv = document.getElementById('error');
            const formatOptions = document.getElementById('formatOptions');
            const downloadProgress = document.getElementById('downloadProgress');
            const statusText = document.getElementById('statusText');
            const downloadLink = document.getElementById('downloadLink');
            const navegadorSelect = document.getElementById('navegadorSelect');
            const navegadorInfo = document.getElementById('navegadorInfo');

            let selectedFormat = null;
            let currentVideoInfo = null;
            let navegadorSeleccionado = 'chrome';

            // Cargar navegadores disponibles
            cargarNavegadores();

            async function cargarNavegadores() {
                try {
                    const response = await fetch('/api/navegadores');
                    const data = await response.json();
                    
                    navegadorSelect.innerHTML = '';
                    data.navegadores.forEach(nav => {
                        const option = document.createElement('option');
                        option.value = nav.id;
                        option.textContent = nav.nombre;
                        if (nav.default) {
                            option.selected = true;
                            navegadorSeleccionado = nav.id;
                        }
                        navegadorSelect.appendChild(option);
                    });
                    
                    navegadorInfo.style.display = 'block';
                    
                } catch (error) {
                    console.error('Error cargando navegadores:', error);
                    navegadorSelect.innerHTML = '<option value="ninguno">Sin cookies (modo b谩sico)</option>';
                }
            }

            navegadorSelect.addEventListener('change', function() {
                navegadorSeleccionado = this.value;
            });

            btnInfo.addEventListener('click', async function() {
                const url = videoUrl.value.trim();
                
                if (!url) {
                    showError('Por favor, ingresa una URL v谩lida de YouTube');
                    return;
                }

                showLoading(true);
                hideError();

                try {
                    const response = await fetch('/api/info', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ 
                            url: url,
                            navegador: navegadorSeleccionado
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        currentVideoInfo = data;
                        displayVideoInfo(data);
                        
                        // Mostrar advertencia si existe
                        if (data.advertencia) {
                            showWarning(data.advertencia);
                        }
                    } else {
                        showError('Error: ' + (data.error || 'No se pudo obtener informaci贸n del video'));
                    }
                } catch (error) {
                    showError('Error de conexi贸n: ' + error.message);
                } finally {
                    showLoading(false);
                }
            });

            btnDownload.addEventListener('click', async function() {
                if (!selectedFormat || !currentVideoInfo) {
                    showError('Por favor, selecciona un formato primero');
                    return;
                }

                showDownloadStatus(true);
                statusText.textContent = 'Iniciando descarga...';
                downloadProgress.style.width = '10%';

                try {
                    const response = await fetch('/api/download', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            url: videoUrl.value.trim(),
                            formato: selectedFormat.formato,
                            calidad: selectedFormat.calidad,
                            id_formato: selectedFormat.id,
                            navegador: navegadorSeleccionado
                        })
                    });

                    const data = await response.json();

                    if (data.success) {
                        downloadProgress.style.width = '100%';
                        statusText.textContent = '隆Descarga completada!';
                        
                        // Crear enlace de descarga
                        downloadLink.href = `/api/download-file/${encodeURIComponent(data.archivo)}`;
                        downloadLink.download = (data.titulo + '.' + selectedFormat.formato).replace(/[^a-zA-Z0-9.-]/g, '_');
                        downloadLink.style.display = 'inline-block';
                    } else {
                        showError('Error en la descarga: ' + (data.error || 'Error desconocido'));
                        showDownloadStatus(false);
                    }
                } catch (error) {
                    showError('Error de conexi贸n: ' + error.message);
                    showDownloadStatus(false);
                }
            });

            function displayVideoInfo(info) {
                document.getElementById('videoTitle').textContent = info.titulo;
                document.getElementById('videoAuthor').textContent = info.autor;
                document.getElementById('videoDuration').textContent = formatDuration(info.duracion);
                document.getElementById('videoViews').textContent = formatViews(info.vistas);
                
                const thumbnail = document.getElementById('videoThumbnail');
                if (info.thumbnail) {
                    thumbnail.src = info.thumbnail;
                    thumbnail.style.display = 'block';
                } else {
                    thumbnail.style.display = 'none';
                }

                // Mostrar opciones de formato
                formatOptions.innerHTML = '';

                // Opci贸n de audio
                if (info.formato_audio) {
                    const audioCard = createFormatCard(info.formato_audio, 'audio');
                    formatOptions.appendChild(audioCard);
                }

                // Opciones de video
                if (info.formatos_video && info.formatos_video.length > 0) {
                    info.formatos_video.forEach(format => {
                        const card = createFormatCard(format, 'video');
                        formatOptions.appendChild(card);
                    });
                } else {
                    formatOptions.innerHTML = '<div class="warning">No se encontraron formatos de video. Intenta con otro navegador.</div>';
                }

                videoInfo.classList.add('visible');
            }

            function createFormatCard(format, type) {
                const card = document.createElement('div');
                card.className = 'format-card';
                card.innerHTML = `
                    <h4>${type === 'audio' ? 'Audio' : 'Video'} ${format.calidad}</h4>
                    <p>Formato: ${format.formato.toUpperCase()}</p>
                `;

                card.addEventListener('click', () => {
                    // Deseleccionar todas las tarjetas
                    document.querySelectorAll('.format-card').forEach(c => {
                        c.classList.remove('selected');
                    });

                    // Seleccionar esta tarjeta
                    card.classList.add('selected');
                    selectedFormat = format;
                    btnDownload.disabled = false;
                });

                return card;
            }

            function showWarning(message) {
                const warningDiv = document.createElement('div');
                warningDiv.className = 'warning';
                warningDiv.textContent = message;
                videoInfo.insertBefore(warningDiv, videoInfo.firstChild);
            }

            function formatDuration(seconds) {
                if (!seconds) return 'Desconocida';
                const hours = Math.floor(seconds / 3600);
                const minutes = Math.floor((seconds % 3600) / 60);
                const secs = seconds % 60;
                
                if (hours > 0) {
                    return `${hours}h ${minutes}m ${secs}s`;
                }
                return `${minutes}m ${secs}s`;
            }

            function formatViews(views) {
                if (!views) return 'Desconocidas';
                if (views >= 1000000) {
                    return (views / 1000000).toFixed(1) + 'M';
                } else if (views >= 1000) {
                    return (views / 1000).toFixed(1) + 'K';
                }
                return views.toString();
            }

            function showLoading(show) {
                loading.style.display = show ? 'block' : 'none';
                btnInfo.disabled = show;
            }

            function showDownloadStatus(show) {
                downloadStatus.style.display = show ? 'block' : 'none';
                if (show) {
                    downloadStatus.classList.add('visible');
                } else {
                    downloadStatus.classList.remove('visible');
                }
            }

            function showError(message) {
                errorDiv.textContent = message;
                errorDiv.classList.add('visible');
            }

            function hideError() {
                errorDiv.classList.remove('visible');
            }
        });
    </script>
</body>
</html>